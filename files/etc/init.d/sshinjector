#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1
PROG=/usr/bin/ssh
INJECTOR=/usr/bin/ssh_payload_injector.py
TUN2SOCKS=/usr/bin/badvpn-tun2socks

start_service() {
    config_load "sshinjector"
    local section="general"
    
    config_get_bool enabled "$section" "enabled" 0
    [ "$enabled" -eq 1 ] || return 0

    config_get remote_host "$section" "remote_host"
    config_get remote_port "$section" "remote_port" "22"
    config_get username "$section" "username"
    config_get password "$section" "password"
    config_get payload "$section" "payload"
    config_get local_port "$section" "local_port" "1080"
    config_get proxy_ip "$section" "proxy_ip"
    config_get proxy_port "$section" "proxy_port"
    
    config_get_bool vpn_mode "$section" "vpn_mode" 0
    config_get tun_dev "$section" "tun_dev" "tun0"
    config_get tun_net "$section" "tun_net" "10.255.0.2"

    if [ -z "$remote_host" ] || [ -z "$username" ] || [ -z "$payload" ]; then
        return 1
    fi

    local injector_cmd="$INJECTOR --host %h --port %p --payload '$payload'"
    if [ -n "$proxy_ip" ] && [ -n "$proxy_port" ]; then
        injector_cmd="$injector_cmd --proxy_ip $proxy_ip --proxy_port $proxy_port"
    fi

    local ssh_cmd="$PROG -D 0.0.0.0:$local_port -N -v -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ExitOnForwardFailure=yes -o ProxyCommand=\"$injector_cmd\" -p $remote_port $username@$remote_host"

    procd_open_instance "ssh_tunnel"
    if [ -n "$password" ]; then
        procd_set_param command /usr/bin/sshpass -p "$password" $ssh_cmd
    else
        procd_set_param command $ssh_cmd
    fi
    procd_set_param respawn
    procd_close_instance

    if [ "$vpn_mode" -eq 1 ]; then
        local gateway=$(ip route show | grep default | awk '{print $3}' | head -n 1)
        local wan_iface=$(ip route show | grep default | awk '{print $5}' | head -n 1)
        local remote_ip=$(nslookup $remote_host | awk '/^Address: / { print $2 }' | head -n 1)
        if [ -z "$remote_ip" ]; then remote_ip=$remote_host; fi
        
        ip route add $remote_ip via $gateway dev $wan_iface metric 1

        procd_open_instance "tun2socks"
        procd_set_param command $TUN2SOCKS --tundev $tun_dev --netif-ipaddr $tun_net --netif-netmask 255.255.255.0 --socks-server-addr 127.0.0.1:$local_port
        procd_set_param respawn
        procd_close_instance

        (
            sleep 5
            ifconfig $tun_dev $tun_net netmask 255.255.255.0 up
            ip route add 0.0.0.0/1 via $tun_net dev $tun_dev
            ip route add 128.0.0.0/1 via $tun_net dev $tun_dev
            iptables -t nat -A POSTROUTING -o $tun_dev -j MASQUERADE
            iptables -A FORWARD -i br-lan -o $tun_dev -j ACCEPT
            iptables -A FORWARD -i $tun_dev -o br-lan -j ACCEPT
        ) &
    fi
}

stop_service() {
    config_load "sshinjector"
    config_get_bool vpn_mode "general" "vpn_mode" 0
    config_get tun_dev "general" "tun_dev" "tun0"
    config_get remote_host "general" "remote_host"
    
    if [ "$vpn_mode" -eq 1 ]; then
        local remote_ip=$(nslookup $remote_host | awk '/^Address: / { print $2 }' | head -n 1)
        if [ -z "$remote_ip" ]; then remote_ip=$remote_host; fi
        
        ip route del 0.0.0.0/1 dev $tun_dev 2>/dev/null
        ip route del 128.0.0.0/1 dev $tun_dev 2>/dev/null
        ip route del $remote_ip 2>/dev/null
        iptables -t nat -D POSTROUTING -o $tun_dev -j MASQUERADE 2>/dev/null
        iptables -D FORWARD -i br-lan -o $tun_dev -j ACCEPT 2>/dev/null
    fi
}
