name: Build OpenWrt Package

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  SDK_VERSION: "24.10.0"
  ARCH: "aarch64_cortex-a53"

jobs:
  build_package:
    name: Build Universal Package
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache SDK and ccache
        uses: actions/cache@v4
        with:
          path: |
            sdk/
            ~/.ccache/
          key: ${{ runner.os }}-sdk-${{ env.SDK_VERSION }}-${{ env.ARCH }}-${{ hashFiles('Makefile', 'files/**') }}
          restore-keys: |
            ${{ runner.os }}-sdk-${{ env.SDK_VERSION }}-${{ env.ARCH }}-

      - name: Download Universal SDK
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ SDK Ð´Ð»Ñ generic target - Ð¾Ð½ Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÐµÐ½
          # Ð”Ð»Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹ aarch64_cortex-a53 ÐµÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²
          # Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÐ°Ð¼Ñ‹Ð¹ Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð±Ñ‰Ð¸Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚
          
          # Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð”Ð»Ñ Ð¼ÐµÐ´Ð¸Ð°Ñ‚ÐµÐº ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð² (ÑÐ°Ð¼Ñ‹Ð¹ Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹)
          SDK_URL="https://downloads.openwrt.org/releases/${{ env.SDK_VERSION }}/targets/mediatek/filogic/openwrt-sdk-${{ env.SDK_VERSION }}-${{ env.ARCH }}_gcc-13.3.0_musl.Linux-x86_64.tar.xz"
          
          # Ð•ÑÐ»Ð¸ Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ðµ:
          # Ð”Ð»Ñ Rockchip: rockchip/armv8
          # Ð”Ð»Ñ Qualcomm: qualcommax/armv8
          
          echo "Downloading SDK from: $SDK_URL"
          wget -q --show-progress "$SDK_URL" -O sdk.tar.xz || {
            echo "Trying alternative SDK URL..."
            # ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð°: generic aarch64_generic
            SDK_URL="https://downloads.openwrt.org/releases/${{ env.SDK_VERSION }}/targets/armsr/armv8/openwrt-sdk-${{ env.SDK_VERSION }}-aarch64_generic_gcc-13.3.0_musl.Linux-x86_64.tar.xz"
            wget -q --show-progress "$SDK_URL" -O sdk.tar.xz
          }
          
          mkdir -p sdk
          tar -xf sdk.tar.xz -C sdk --strip-components=1
          rm sdk.tar.xz

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.3
        with:
          key: ${{ runner.os }}-ccache-${{ env.SDK_VERSION }}
          create-symlink: true
          max-size: 1G

      - name: Install minimal dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            ccache \
            file \
            gawk \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-setuptools \
            unzip \
            wget \
            rsync \
            time \
            zlib1g-dev
          
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ ccache Ð´Ð»Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
          ccache --set-config=max_size=1G
          ccache --set-config=compression=true
          ccache --set-config=compression_level=1
          ccache --set-config=sloppiness=file_macro,include_file_ctime,include_file_mtime
          ccache -s

      - name: Prepare Package Structure
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ð°ÐºÐµÑ‚Ð°
          PACKAGE_DIR="sdk/package/luci-app-sshinjector"
          mkdir -p "$PACKAGE_DIR"
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          [ -f Makefile ] && cp Makefile "$PACKAGE_DIR/"
          [ -d files ] && cp -r files "$PACKAGE_DIR/"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ src Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²
          if [ -d src ]; then
            mkdir -p "$PACKAGE_DIR/src"
            cp -r src/* "$PACKAGE_DIR/src/"
          fi

      - name: Optimized Build Configuration
        env:
          CCACHE_DIR: /home/runner/.ccache
          CCACHE_MAXSIZE: 1G
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²ÑÐµ ÑÐ´Ñ€Ð° Ð´Ð»Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸
          MAKE_JOBS: $(( $(nproc) * 2 ))
        run: |
          cd sdk
          
          # Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
          export FORCE_UNSAFE_CONFIGURE=1
          export DEBIAN_FRONTEND=noninteractive
          
          echo "=== Build Configuration ==="
          echo "Architecture: ${{ env.ARCH }}"
          echo "SDK Version: ${{ env.SDK_VERSION }}"
          echo "Make Jobs: $MAKE_JOBS"
          echo "CCache Stats:"
          ccache -s
          
          # ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ feeds Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ
          echo "Updating feeds (minimal)..."
          [ ! -f .feeds_configured ] && {
            ./scripts/feeds update -a
            ./scripts/feeds install -a luci-compat python3
            touch .feeds_configured
          }
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
          cat > .config << 'EOF'
CONFIG_TARGET_${{ env.ARCH }}=y
CONFIG_TARGET_${{ env.ARCH }}_DEFAULT=y
CONFIG_PACKAGE_luci-app-sshinjector=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-lib-ipkg=y
CONFIG_PACKAGE_python3=y
CONFIG_PACKAGE_python3-light=y
# ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ LuCI
CONFIG_LUCI_LANG_en=y
CONFIG_LUCI_LANG_ru=y
EOF
          
          # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ ARCH Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ
          sed -i "s/\${{ env.ARCH }}/${{ env.ARCH }}/g" .config
          
          # Ð£ÑÐºÐ¾Ñ€ÑÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_SDK=y" >> .config
          echo "CONFIG_STRIP_ARGS=\"--strip-all\"" >> .config
          
          echo "=== Config File ==="
          grep -E "CONFIG_(TARGET|PACKAGE|LUCI)" .config || true

      - name: Fast Compile Package
        env:
          MAKE_JOBS: $(( $(nproc) * 2 ))
          CCACHE_DIR: /home/runner/.ccache
        run: |
          cd sdk
          
          echo "Starting fast compilation..."
          time make defconfig 2>&1 | tail -20
          
          echo "Compiling package only..."
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñˆ Ð¿Ð°ÐºÐµÑ‚ Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹
          time make package/luci-app-sshinjector/compile \
            V=s \
            -j$MAKE_JOBS \
            CC="ccache gcc" \
            CXX="ccache g++" \
            STRIP="echo skipping strip" \
            IGNORE_ERRORS=m \
            BUILD_LOG=1 2>&1 | tail -100
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
          echo "=== Build Results ==="
          find bin -name "*.ipk" -type f 2>/dev/null | head -20 || true
          
          if find bin -name "*luci-app-sshinjector*.ipk" -type f 2>/dev/null | grep -q .; then
            echo "âœ… Build successful!"
            echo "Generated packages:"
            find bin -name "*luci-app-sshinjector*.ipk" -type f -exec ls -lh {} \;
          else
            echo "âŒ Build failed - no IPK files found"
            echo "Checking for errors..."
            find . -name "*.log" -type f -exec grep -l "Error\|error\|failed" {} \; | head -5 | xargs cat | tail -50
            exit 1
          fi

      - name: Collect and Rename Artifacts
        run: |
          echo "Collecting artifacts..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
          mkdir -p artifacts
          
          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð²ÑÐµ ipk Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð°ÑˆÐµÐ³Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð°
          find sdk -name "*luci-app-sshinjector*.ipk" -type f 2>/dev/null | while read ipk; do
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ð¾Ðµ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°
            basename=$(basename "$ipk")
            
            # Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ: ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð½Ñ‹Ðµ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸ÐºÐ¸
            # ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð¼Ñ Ð¿Ð°ÐºÐµÑ‚Ð° Ð¸ Ð²ÐµÑ€ÑÐ¸ÑŽ
            newname=$(echo "$basename" | sed -E 's/_aarch64_cortex-a53_/_all_/g' | sed -E 's/_aarch64_generic_/_all_/g')
            
            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ Ð½Ð¾Ð²Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼
            cp "$ipk" "artifacts/$newname"
            echo "ðŸ“¦ Created: artifacts/$newname"
          done
          
          # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð¸ÑÐºÐ°Ñ‚ÑŒ Ð¿Ð¾-Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ
          if [ -z "$(ls -A artifacts/*.ipk 2>/dev/null)" ]; then
            echo "Trying alternative search..."
            find sdk -name "*.ipk" -type f -exec cp {} artifacts/ \;
          fi
          
          # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÑÐ¿Ð¸ÑÐ¾Ðº
          echo "=== Final Artifacts ==="
          ls -la artifacts/*.ipk 2>/dev/null || echo "No IPK files found"

      - name: Upload Universal Package
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-sshinjector-universal
          path: artifacts/*.ipk
          retention-days: 30
          if-no-files-found: error
          
      - name: Upload SDK Cache
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sdk-cache-backup
          path: sdk/
          retention-days: 7

      - name: Show Build Summary
        if: always()
        run: |
          echo "=== Build Summary ==="
          echo "SDK Version: ${{ env.SDK_VERSION }}"
          echo "Architecture: ${{ env.ARCH }}"
          echo "Build Time: $(date)"
          echo "CCache Stats:"
          ccache -s 2>/dev/null || echo "CCache not available"
          
          echo "Artifacts:"
          ls -la artifacts/*.ipk 2>/dev/null || echo "No artifacts found"
