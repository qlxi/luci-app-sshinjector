name: Build OpenWrt Package for OpenWrt One

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'SDK Version'
        required: true
        default: '24.10.0'
        type: choice
        options:
          - '24.10.0'
          - 'snapshots'

env:
  SDK_VERSION: ${{ github.event.inputs.sdk_version || '24.10.0' }}

jobs:
  build_package:
    name: Build for OpenWrt One (MT7981B)
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    
    # Выделяем больше ресурсов для сборки
    strategy:
      matrix:
        # OpenWrt One использует SoC Mediatek MT7981B (Filogic 820)
        target: [mediatek/filogic]
        include:
          - target: mediatek/filogic
            subtarget: mt7981
            profile: openwrt_one
            arch: aarch64_cortex-a53

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Только последний коммит для ускорения

      - name: Setup build environment
        run: |
          sudo apt-get update
          # Минимальный набор зависимостей для сборки пакетов
          sudo apt-get install -y \
            build-essential \
            ccache \
            file \
            gawk \
            gettext \
            git \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            rsync \
            unzip \
            wget \
            zlib1g-dev \
            jq \
            curl
          
          # Устанавливаем размер ccache кэша
          ccache -M 2G
          ccache -s

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: openwrt-one-ccache-${{ env.SDK_VERSION }}-${{ hashFiles('Makefile') }}
          max-size: 2G

      - name: Cache SDK and downloads
        uses: actions/cache@v4
        id: sdk-cache
        with:
          path: |
            sdk
            dl
          key: ${{ runner.os }}-openwrt-one-sdk-${{ env.SDK_VERSION }}-${{ matrix.target }}-${{ hashFiles('Makefile', 'package/*', 'files/*') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-one-sdk-${{ env.SDK_VERSION }}-${{ matrix.target }}-
            ${{ runner.os }}-openwrt-one-sdk-

      - name: Download OpenWrt SDK
        if: steps.sdk-cache.outputs.cache-hit != 'true'
        run: |
          # Определяем URL SDK в зависимости от версии
          if [ "${{ env.SDK_VERSION }}" = "snapshots" ]; then
            SDK_URL="https://downloads.openwrt.org/snapshots/targets/${{ matrix.target }}/openwrt-sdk-${{ matrix.target }}-gcc-13.2.0_musl.Linux-x86_64.tar.xz"
          else
            SDK_URL="https://downloads.openwrt.org/releases/${{ env.SDK_VERSION }}/targets/${{ matrix.target }}/openwrt-sdk-${{ matrix.target }}-gcc-13.2.0_musl.Linux-x86_64.tar.xz"
          fi
          
          echo "Downloading SDK from: $SDK_URL"
          
          # Пробуем скачать с несколькими попытками
          for i in {1..3}; do
            if wget --no-check-certificate --progress=dot:giga -O openwrt-sdk.tar.xz "$SDK_URL"; then
              echo "Download successful"
              break
            elif [ $i -eq 3 ]; then
              echo "Failed to download SDK after 3 attempts"
              exit 1
            else
              echo "Download failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
          
          # Распаковываем SDK
          mkdir -p sdk
          tar -xf openwrt-sdk.tar.xz -C sdk --strip-components=1
          rm -f openwrt-sdk.tar.xz
          
          # Создаем директорию для загрузок
          mkdir -p dl
          
          # Проверяем архитектуру SDK
          echo "SDK architecture info:"
          find sdk -name "*.mk" -exec grep -h "ARCH:=aarch64" {} \; | head -5

      - name: Prepare package in SDK
        run: |
          # Создаем директорию для пакета
          PKG_DIR="sdk/package/luci-app-sshinjector"
          mkdir -p "$PKG_DIR"
          
          # Копируем все файлы пакета
          echo "Copying package files..."
          cp -r ./* "$PKG_DIR"/ 2>/dev/null || true
          
          # Удаляем ненужные файлы из SDK-директории
          rm -rf "$PKG_DIR"/.git "$PKG_DIR"/.github 2>/dev/null || true
          
          # Проверяем, что Makefile существует
          if [ ! -f "$PKG_DIR/Makefile" ]; then
            echo "Error: Makefile not found in package directory!"
            exit 1
          fi
          
          echo "Package prepared successfully"

      - name: Configure SDK for fast compilation
        run: |
          cd sdk
          
          # Создаем базовую конфигурацию
          cat > .config << EOF
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
CONFIG_SIGNED_PACKAGES=n
CONFIG_STRIP_KERNEL_EXPORTS=y
CONFIG_USE_MKLIBS=n
CONFIG_TARGET_ROOTFS_INITRAMFS=n
CONFIG_TARGET_ROOTFS_CPIOGZ=n
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=n
CONFIG_PACKAGE_luci-app-sshinjector=m
EOF
          
          # Включаем поддержку aarch64_cortex-a53
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_openwrt_one=y" >> .config
          
          # Включаем необходимые зависимости
          echo "CONFIG_PACKAGE_luci-compat=y" >> .config
          echo "CONFIG_PACKAGE_luci-lib-ipkg=y" >> .config
          
          # Обновляем фиды только если нужно
          if [ ! -f ".feeds_updated" ]; then
            echo "Updating feeds..."
            ./scripts/feeds update -a
            ./scripts/feeds install -a
            touch .feeds_updated
          fi

      - name: Compile package with optimizations
        run: |
          cd sdk
          
          # Применяем конфигурацию
          make defconfig
          
          # Проверяем конфигурацию пакета
          echo "Checking package configuration..."
          grep -n "luci-app-sshinjector" .config || true
          
          # Определяем количество ядер для параллельной сборки
          CPUS=$(nproc)
          echo "Using $CPUS CPU cores for parallel build"
          
          # Собираем только наш пакет с оптимизациями
          echo "Starting compilation..."
          
          # Используем отдельную команду для сборки только пакета
          make tools/install -j$CPUS
          make toolchain/install -j$CPUS
          
          # Теперь собираем наш пакет
          time make package/luci-app-sshinjector/compile \
            V=sc \
            -j$((CPUS + 2)) \
            BUILD_LOG=1 \
            CCACHE=1 \
            IGNORE_ERRORS=n \
            2>&1 | tee build.log
          
          # Проверяем результат сборки
          if [ $? -eq 0 ]; then
            echo "Compilation successful!"
            
            # Ищем собранные пакеты
            find bin -name "*.ipk" -type f | grep -i sshinjector | while read ipk; do
              echo "Found package: $ipk"
              # Копируем в рабочую директорию
              cp "$ipk" ../
            done
          else
            echo "Compilation failed, checking error log..."
            tail -100 build.log
            exit 1
          fi

      - name: List built packages
        run: |
          echo "Built packages:"
          ls -la *.ipk 2>/dev/null || echo "No IPK files found"
          
          if [ -d "sdk/bin" ]; then
            echo "Contents of SDK bin directory:"
            find sdk/bin -name "*.ipk" -type f | head -20
          fi

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-sshinjector-openwrt-one-${{ env.SDK_VERSION }}
          path: |
            *.ipk
          retention-days: 30
          compression-level: 0  # Без сжатия для ускорения

      - name: Upload build log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-openwrt-one
          path: |
            sdk/build.log
            sdk/.config
          retention-days: 7

      - name: Show ccache statistics
        if: always()
        run: |
          ccache -s
          echo "Cache directory size:"
          du -sh ~/.ccache 2>/dev/null || echo "No ccache directory"

  test_build:
    name: Test package structure
    runs-on: ubuntu-latest
    needs: build_package
    if: always()
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: luci-app-sshinjector-openwrt-one-${{ env.SDK_VERSION }}
          
      - name: Check package structure
        run: |
          echo "Testing package structure..."
          if ls *.ipk 1> /dev/null 2>&1; then
            echo "IPK files found:"
            ls *.ipk
            
            # Проверяем содержимое одного пакета
            for ipk in *.ipk; do
              echo "Checking $ipk..."
              # Извлекаем контрольную информацию
              tar -xzOf "$ipk" ./control.tar.gz | tar -tz | head -20
              break
            done
          else
            echo "No IPK files found in artifact"
          fi
