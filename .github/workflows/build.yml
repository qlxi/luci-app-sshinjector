name: Build OpenWrt Package

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build_package:
    name: Build OpenWrt 24.10 - ${{ matrix.target }}
    runs-on: ubuntu-24.04 # Более новая версия Ubuntu для лучшей совместимости
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        target: [mediatek/mt7622] # aarch64_cortex-a53 для MT7622, измените под свою платформу

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-dev python3-pip \
            python3-setuptools rsync unzip wget xsltproc zlib1g-dev \
            python-is-python3 subversion

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-openwrt-ccache
          max-size: 500M

      - name: Cache OpenWrt SDK
        uses: actions/cache@v4
        id: sdk-cache
        with:
          path: |
            sdk
            dl
          key: ${{ runner.os }}-sdk-24.10-${{ matrix.target }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            ${{ runner.os }}-sdk-24.10-${{ matrix.target }}-
            ${{ runner.os }}-sdk-24.10-

      - name: Download and extract SDK
        if: steps.sdk-cache.outputs.cache-hit != 'true'
        run: |
          # Для 24.10 SDK доступны в snapshots
          SDK_URL="https://downloads.openwrt.org/snapshots/targets/${{ matrix.target }}/openwrt-sdk-${{ matrix.target }}-gcc-13.2.0_musl.Linux-x86_64.tar.xz"
          
          echo "Downloading SDK from: $SDK_URL"
          wget --no-check-certificate --progress=dot:giga $SDK_URL || \
          wget --progress=dot:giga $SDK_URL
          
          # Создаем директорию для SDK
          mkdir -p sdk
          tar -xf openwrt-sdk-*.tar.xz -C sdk --strip-components=1
          rm -f openwrt-sdk-*.tar.xz
          
          # Создаем директорию для загрузок
          mkdir -p dl

      - name: Prepare package
        run: |
          # Создаем директорию для нашего пакета в SDK
          mkdir -p sdk/package/luci-app-sshinjector
          
          # Копируем все файлы пакета, кроме .git
          find . -maxdepth 1 -type f -name "*" ! -name ".git*" -exec cp {} sdk/package/luci-app-sshinjector/ \;
          
          # Копируем директории
          if [ -d "files" ]; then
            cp -r files sdk/package/luci-app-sshinjector/
          fi
          
          if [ -d "src" ]; then
            cp -r src sdk/package/luci-app-sshinjector/
          fi
          
          echo "Package files copied to SDK"

      - name: Configure ccache in SDK
        run: |
          cd sdk
          # Включаем ccache в SDK
          echo "CCACHE_DIR=/tmp/ccache" >> .config
          echo "BUILD_CCACHE=1" >> .config
          
          # Увеличиваем кэш компилятора
          if [ -f feeds.conf.default ]; then
            # Если есть стандартный конфиг фидов, используем его
            cp feeds.conf.default feeds.conf
          fi

      - name: Setup parallel build
        run: |
          cd sdk
          # Определяем количество ядер для параллельной сборки
          CPUS=$(nproc)
          echo "Using $CPUS CPU cores for parallel build"
          
          # Настраиваем параллельную сборку
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
          
          # Включаем наш пакет
          echo "CONFIG_PACKAGE_luci-app-sshinjector=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-sshinjector-zh-cn=y" >> .config

      - name: Update feeds (cache optimized)
        run: |
          cd sdk
          # Обновляем фиды только если не было кэша
          if [ ! -f ".feeds_updated" ]; then
            ./scripts/feeds update -a
            ./scripts/feeds install -a
            touch .feeds_updated
          else
            echo "Feeds already updated, using cache"
          fi

      - name: Compile package (optimized)
        run: |
          cd sdk
          # Создаем конфигурацию по умолчанию
          make defconfig
          
          # Компилируем только наш пакет с оптимизациями
          CPUS=$(nproc)
          
          echo "Starting compilation with $CPUS threads..."
          time make package/luci-app-sshinjector/compile \
            V=s \
            -j$((CPUS + 1)) \
            BUILD_LOG=1 \
            CCACHE=1
          
          # Проверяем успешность сборки
          if [ -f "bin/packages/*/base/luci-app-sshinjector_*.ipk" ]; then
            echo "Package built successfully!"
            ls -la bin/packages/*/base/luci-app-sshinjector_*.ipk
          fi

      - name: Find and upload artifacts
        run: |
          cd sdk
          # Ищем собранные пакеты
          find bin/packages -name "luci-app-sshinjector_*.ipk" -type f | while read file; do
            echo "Found package: $file"
            # Копируем в корневую директорию для артефакта
            cp "$file" ../
          done
          
          # Также ищем переводы
          find bin/packages -name "luci-i18n-sshinjector-*.ipk" -type f | while read file; do
            echo "Found translation: $file"
            cp "$file" ../
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-sshinjector-${{ matrix.target }}-24.10
          path: |
            luci-app-sshinjector_*.ipk
            luci-i18n-sshinjector-*.ipk
          retention-days: 7

      - name: Cleanup (optional)
        if: always()
        run: |
          # Очищаем временные файлы, но сохраняем кэш
          rm -f openwrt-sdk-*.tar.xz
          # Сохраняем ccache кэш
          ccache -s
